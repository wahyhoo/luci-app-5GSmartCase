name: Build OpenWrt IPK Package

on:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'OpenWrt Version'
        required: true
        default: '22.03'
        type: choice
        options:
          - '21.02'
          - '22.03'
          - '23.05'
      target:
        description: 'Device Architecture'
        required: true
        default: 'x86_64'
        type: choice
        options:
          - 'x86_64'
          - 'aarch64_generic'
          - 'arm_cortex-a7'
          - 'mipsel_24kc'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build IPK
        uses: docker://openwrtorg/sdk:latest
        env:
          OPENWRT_VERSION: ${{ github.event.inputs.openwrt_version }}
          TARGET: ${{ github.event.inputs.target }}
        with:
          args: |
            sh -c "
            # 安装依赖
            apt-get update && apt-get install -y subversion gcc g++ libncurses5-dev python3 rsync
            # 下载对应版本的SDK并解压
            SDK_URL=\"https://downloads.openwrt.org/releases/\$OPENWRT_VERSION/targets/\${TARGET//_/\/}/openwrt-sdk-\$OPENWRT_VERSION-\$TARGET_gcc-12.3.0_musl.Linux-x86_64.tar.xz\"
            wget -O sdk.tar.xz \$SDK_URL
            tar -xf sdk.tar.xz --strip-components=1 -C /opt/sdk
            # 准备编译环境
            cd /opt/sdk
            # 将当前仓库的代码复制到SDK的package目录下
            cp -r $GITHUB_WORKSPACE package/luci-app-5GSmartCase
            # 开始编译
            make defconfig
            make package/luci-app-5GSmartCase/compile V=s
            # 复制生成的ipk文件到工作区，以便上传
            find bin/ -name '*.ipk' -exec cp {} $GITHUB_WORKSPACE \;
            "

      - name: Upload IPK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: built-ipk-${{ github.event.inputs.target }}
          path: "*.ipk"
